<!DOCTYPE html>
<html lang="en">
<%- include('partials/head', { title: 'Appointments - Lilith.Eve' }) %>
<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <%- include('partials/sidebar', { active: 'appointments' }) %>
        
        <!-- Main Content -->
        <div class="main-content flex-1 flex flex-col h-screen ml-64 overflow-auto">
            <%- include('partials/header', { 
                title: 'Appointments', 
                subtitle: 'Schedule and manage patient appointments' 
            }) %>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6">
                <!-- Action Bar -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-3">
                        <h2 class="text-xl font-semibold text-gray-900">Appointment Calendar</h2>
                        <div class="relative">
                            <button id="calendar-view-toggle" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="far fa-calendar-alt mr-2"></i>
                                <span id="current-view">Week</span>
                                <i class="fas fa-chevron-down ml-2 text-xs"></i>
                            </button>
                            <div id="view-dropdown" class="hidden absolute z-10 mt-1 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                                <div class="py-1" role="menu" aria-orientation="vertical">
                                    <a href="#" data-view="day" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Day</a>
                                    <a href="#" data-view="week" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Week</a>
                                    <a href="#" data-view="month" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Month</a>
                                    <a href="#" data-view="agenda" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Agenda</a>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="prev-period" class="p-1 rounded-full text-gray-500 hover:bg-gray-100">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="current-period" class="text-sm font-medium">Oct 15 - 21, 2023</span>
                            <button id="next-period" class="p-1 rounded-full text-gray-500 hover:bg-gray-100">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button id="today-btn" class="ml-2 px-3 py-1 text-sm text-indigo-600 hover:text-indigo-800">
                                Today
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" placeholder="Search appointments..." class="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <button id="new-appointment" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-plus mr-2"></i> New Appointment
                        </button>
                    </div>
                </div>

                <!-- Calendar Header -->
                <div class="bg-white rounded-t-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-7 gap-px bg-gray-200 border-b border-gray-200">
                        <% const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; %>
                        <% days.forEach(day => { %>
                            <div class="bg-gray-50 py-2 px-3 text-sm font-medium text-gray-500 text-center">
                                <%= day.substring(0, 3) %>
                            </div>
                        <% }) %>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white rounded-b-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-7 gap-px bg-gray-200">
                        <% 
                        // Generate calendar days (example for one week)
                        const startDate = new Date('2023-10-15');
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        for (let i = 0; i < 7; i++) { 
                            const currentDate = new Date(startDate);
                            currentDate.setDate(startDate.getDate() + i);
                            const isToday = currentDate.toDateString() === today.toDateString();
                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                            const dayClass = isToday 
                                ? 'bg-indigo-50 text-indigo-700 font-semibold' 
                                : isWeekend 
                                    ? 'bg-gray-50' 
                                    : 'bg-white';
                            
                            // Sample appointments for demonstration
                            const appointments = [];
                            if (i === 1) { // Tuesday
                                appointments.push({ 
                                    id: 1, 
                                    time: '09:30 AM', 
                                    title: 'John Smith - Annual Checkup', 
                                    type: 'checkup',
                                    status: 'confirmed'
                                });
                                appointments.push({ 
                                    id: 2, 
                                    time: '11:15 AM', 
                                    title: 'Maria Garcia - Follow-up', 
                                    type: 'followup',
                                    status: 'confirmed'
                                });
                            }
                            if (i === 2) { // Wednesday
                                appointments.push({ 
                                    id: 3, 
                                    time: '02:00 PM', 
                                    title: 'David Kim - Consultation', 
                                    type: 'consultation',
                                    status: 'pending'
                                });
                            }
                            if (i === 4) { // Friday
                                appointments.push({ 
                                    id: 4, 
                                    time: '10:00 AM', 
                                    title: 'Sarah Johnson - Vaccination', 
                                    type: 'vaccination',
                                    status: 'confirmed'
                                });
                                appointments.push({ 
                                    id: 5, 
                                    time: '03:30 PM', 
                                    title: 'Michael Brown - Physical', 
                                    type: 'physical',
                                    status: 'confirmed'
                                });
                            }
                        %>
                            <div class="min-h-32 <%= dayClass %> p-2 border-r border-gray-200 last:border-r-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm <%= isToday ? 'bg-indigo-600 text-white rounded-full h-6 w-6 flex items-center justify-center' : '' %>">
                                        <%= currentDate.getDate() %>
                                    </span>
                                    <% if (appointments.length > 0) { %>
                                        <span class="h-5 w-5 rounded-full bg-indigo-100 text-indigo-800 text-xs flex items-center justify-center">
                                            <%= appointments.length %>
                                        </span>
                                    <% } else { %>
                                        <span class="h-5 w-5"></span>
                                    <% } %>
                                </div>
                                <div class="space-y-1 max-h-24 overflow-y-auto">
                                    <% appointments.forEach(apt => { 
                                        let typeClass = '';
                                        switch(apt.type) {
                                            case 'checkup':
                                                typeClass = 'bg-blue-100 text-blue-800 border-l-4 border-blue-500';
                                                break;
                                            case 'followup':
                                                typeClass = 'bg-purple-100 text-purple-800 border-l-4 border-purple-500';
                                                break;
                                            case 'consultation':
                                                typeClass = 'bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500';
                                                break;
                                            case 'vaccination':
                                                typeClass = 'bg-green-100 text-green-800 border-l-4 border-green-500';
                                                break;
                                            case 'physical':
                                                typeClass = 'bg-indigo-100 text-indigo-800 border-l-4 border-indigo-500';
                                                break;
                                            default:
                                                typeClass = 'bg-gray-100 text-gray-800 border-l-4 border-gray-500';
                                        }
                                    %>
                                        <div class="text-xs p-1 rounded-r <%= typeClass %> cursor-pointer hover:opacity-90" 
                                             onclick="showAppointmentDetails('<%= JSON.stringify(apt).replace(/'/g, '\\') %>')">
                                            <div class="font-medium truncate"><%= apt.title %></div>
                                            <div class="text-opacity-80"><%= apt.time %></div>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Upcoming Appointments -->
                <div class="mt-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Upcoming Appointments</h3>
                        <div class="flex items-center space-x-2">
                            <button class="text-sm text-indigo-600 hover:text-indigo-800">View All</button>
                        </div>
                    </div>
                    
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <ul class="divide-y divide-gray-200">
                            <% 
                            const upcomingAppointments = [
                                { 
                                    id: 1, 
                                    date: '2023-10-17',
                                    time: '09:30 AM', 
                                    title: 'John Smith - Annual Checkup', 
                                    type: 'checkup',
                                    status: 'confirmed',
                                    patient: { name: 'John Smith', id: 1001, avatar: 'JS' },
                                    doctor: 'Dr. Sarah Johnson',
                                    notes: 'Annual physical examination and blood work'
                                },
                                { 
                                    id: 2, 
                                    date: '2023-10-17',
                                    time: '11:15 AM', 
                                    title: 'Maria Garcia - Follow-up', 
                                    type: 'followup',
                                    status: 'confirmed',
                                    patient: { name: 'Maria Garcia', id: 1002, avatar: 'MG' },
                                    doctor: 'Dr. Michael Brown',
                                    notes: 'Follow-up for medication adjustment'
                                },
                                { 
                                    id: 3, 
                                    date: '2023-10-18',
                                    time: '02:00 PM', 
                                    title: 'David Kim - Consultation', 
                                    type: 'consultation',
                                    status: 'pending',
                                    patient: { name: 'David Kim', id: 1003, avatar: 'DK' },
                                    doctor: 'Dr. Emily Park',
                                    notes: 'Initial consultation for back pain'
                                },
                                { 
                                    id: 4, 
                                    date: '2023-10-20',
                                    time: '10:00 AM', 
                                    title: 'Sarah Johnson - Vaccination', 
                                    type: 'vaccination',
                                    status: 'confirmed',
                                    patient: { name: 'Sarah Johnson', id: 1004, avatar: 'SJ' },
                                    doctor: 'Dr. Robert Chen',
                                    notes: 'Annual flu shot'
                                },
                                { 
                                    id: 5, 
                                    date: '2023-10-20',
                                    time: '03:30 PM', 
                                    title: 'Michael Brown - Physical', 
                                    type: 'physical',
                                    status: 'confirmed',
                                    patient: { name: 'Michael Brown', id: 1005, avatar: 'MB' },
                                    doctor: 'Dr. Sarah Johnson',
                                    notes: 'Pre-employment physical examination'
                                }
                            ];
                            
                            upcomingAppointments.forEach(apt => {
                                let statusClass = '';
                                let statusText = '';
                                
                                switch(apt.status) {
                                    case 'confirmed':
                                        statusClass = 'bg-green-100 text-green-800';
                                        statusText = 'Confirmed';
                                        break;
                                    case 'pending':
                                        statusClass = 'bg-yellow-100 text-yellow-800';
                                        statusText = 'Pending';
                                        break;
                                    case 'cancelled':
                                        statusClass = 'bg-red-100 text-red-800';
                                        statusText = 'Cancelled';
                                        break;
                                    case 'completed':
                                        statusClass = 'bg-blue-100 text-blue-800';
                                        statusText = 'Completed';
                                        break;
                                }
                                
                                const aptDate = new Date(apt.date);
                                const formattedDate = aptDate.toLocaleDateString('en-US', { 
                                    weekday: 'short', 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                            %>
                                <li class="hover:bg-gray-50">
                                    <div class="px-4 py-4 sm:px-6">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium mr-3">
                                                    <%= apt.patient.avatar %>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-medium text-indigo-600 truncate">
                                                        <a href="/patients/<%= apt.patient.id %>" class="hover:underline">
                                                            <%= apt.patient.name %>
                                                        </a>
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        <%= apt.doctor %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="ml-2 flex-shrink-0 flex">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <%= statusClass %>">
                                                    <%= statusText %>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-2 sm:flex sm:justify-between">
                                            <div class="sm:flex">
                                                <div class="mr-6 flex items-center text-sm text-gray-500">
                                                    <i class="far fa-calendar-alt mr-1.5"></i>
                                                    <%= formattedDate %>
                                                </div>
                                                <div class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                                                    <i class="far fa-clock mr-1.5"></i>
                                                    <%= apt.time %>
                                                </div>
                                            </div>
                                            <div class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                                                <i class="fas fa-stethoscope mr-1.5"></i>
                                                <%= apt.type.charAt(0).toUpperCase() + apt.type.slice(1) %>
                                            </div>
                                        </div>
                                        <% if (apt.notes) { %>
                                            <div class="mt-2 text-sm text-gray-500">
                                                <i class="far fa-sticky-note mr-1.5"></i>
                                                <%= apt.notes %>
                                            </div>
                                        <% } %>
                                    </div>
                                </li>
                            <% }) %>
                        </ul>
                    </div>
                </div>
            </main>
            
            <%- include('partials/footer') %>
        </div>
    </div>
    
    <!-- Appointment Details Modal -->
    <div id="appointment-modal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Appointment Details
                        </h3>
                        <div class="mt-2">
                            <div id="appointment-details" class="text-sm text-gray-500">
                                <!-- Filled by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Edit
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm" onclick="document.getElementById('appointment-modal').classList.add('hidden')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <%- include('partials/chatbox') %>
    
    <script>
        // Toggle view dropdown
        document.getElementById('calendar-view-toggle').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('view-dropdown').classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.getElementById('view-dropdown').classList.add('hidden');
        });
        
        // Handle view selection
        document.querySelectorAll('#view-dropdown a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const view = this.getAttribute('data-view');
                document.getElementById('current-view').textContent = this.textContent;
                document.getElementById('view-dropdown').classList.add('hidden');
                // In a real app, this would update the calendar view
                console.log('Switched to', view, 'view');
            });
        });
        
        // Navigation buttons
        document.getElementById('prev-period').addEventListener('click', function() {
            // In a real app, this would navigate to the previous period
            console.log('Previous period');
        });
        
        document.getElementById('next-period').addEventListener('click', function() {
            // In a real app, this would navigate to the next period
            console.log('Next period');
        });
        
        document.getElementById('today-btn').addEventListener('click', function() {
            // In a real app, this would navigate to today
            console.log('Go to today');
        });
        
        // New appointment button
        document.getElementById('new-appointment').addEventListener('click', function() {
            // In a real app, this would open a new appointment form
            console.log('New appointment');
        });
        
        // Show appointment details
        function showAppointmentDetails(appointment) {
            const modal = document.getElementById('appointment-modal');
            const details = document.getElementById('appointment-details');
            
            // Format the details HTML
            details.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-gray-900">${appointment.title}</h4>
                        <p class="text-gray-500">${appointment.time}</p>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
                                    ${appointment.title.substring(0, 2).toUpperCase()}
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${appointment.title.split(' - ')[0]}</p>
                                <p class="text-sm text-gray-500">Patient</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                                    <i class="fas fa-user-md"></i>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Dr. ${appointment.title.includes('Sarah') ? 'Emily Park' : 'Michael Brown'}</p>
                                <p class="text-sm text-gray-500">Doctor</p>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <h5 class="text-sm font-medium text-gray-900 mb-2">Appointment Type</h5>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize ${getAppointmentTypeClass(appointment.type)}">
                            ${appointment.type}
                        </span>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <h5 class="text-sm font-medium text-gray-900 mb-2">Status</h5>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(appointment.status)}">
                            ${appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}
                        </span>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function getAppointmentTypeClass(type) {
            switch(type) {
                case 'checkup': return 'bg-blue-100 text-blue-800';
                case 'followup': return 'bg-purple-100 text-purple-800';
                case 'consultation': return 'bg-yellow-100 text-yellow-800';
                case 'vaccination': return 'bg-green-100 text-green-800';
                case 'physical': return 'bg-indigo-100 text-indigo-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'confirmed': return 'bg-green-100 text-green-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                case 'completed': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Close modal when clicking outside content
        document.getElementById('appointment-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
